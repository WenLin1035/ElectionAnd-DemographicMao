<!DOCTYPE html>
<!--
Author: Wen Lin
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>State Election and Demographic Data</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="newcss.css">
        <script src='https://unpkg.com/@turf/turf/turf.min.js'></script>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
              integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="crossorigin=""/>
        <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
        <script language="javascript" type="text/javascript" src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
                integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="crossorigin="">
        </script>
    </head>
    <body>
        <div class="split left">
            <div class="centered">
                <h3>Information</h3>
                <div style="padding-bottom:10px">
                    <label for="States" style="font-size: 20px;padding-right: 26px">State:</label>
                    <select id="States" onchange="loadFeature()"> <!-- needs to be replaced by data from DB -->
                        <option value="State" onclick="">State</option>
                    </select>
                </div>
                <div>
                    Selected Precinct: <label id="selectedPrecinct"></label>
                </div>
                <h4>Population:</h4>
                <label id="totVotePop"> X people</label>
                <table cellpadding="0">
                    <tr>
                        <td><label for="dataSection">Data Type:</label></td>
                        <td>
                            <select id="dataSection" onchange="switchDataSection();changeAllColor()" style="">
                                <option value="election">Election</option>
                                <option value="demographic">Demographic</option>
                            </select>
                        </td>
                    </tr>
                    <tr id="electionDropdownArea">
                        <td><label for="year">Election Type:</label></td>
                        <td>
                            <select id="year" onchange="setElectionSection();changeAllColor()" style="">
                                <option id="pred16" value="pred16">Presidential 2016</option>
                                <option id="cong16" value="cong16">Congressional 2016</option>
                                <option id="cong18" value="cong18">Congressional 2018</option>
                            </select>
                        </td>
                    </tr>
                </table>
                <br><br>
                <div id="electionSection">
                    <label>Democratic: </label><label id="demNum">X people [X%]</label><br/> <!-- needs to be replaced by DB data -->
                    <label>Republican: </label><label id="repNum">Y people [Y%]</label><br/> <!-- needs to be replaced by DB data -->
                    <label style="padding-right: 43px">Other:</label><label id="othNum">Z people [Z%]</label><br/> <!-- needs to be replaced by DB data -->
                    <br>
                </div>
                <div id="demographicSection">
                    <label>White: </label><label id="whiteNum" style="padding-left: 20px">X people</label><br/> <!-- needs to be replaced by DB data -->
                    <label>Black: </label><label id="blackNum" style="padding-left: 20px">Y people</label><br/> <!-- needs to be replaced by DB data -->
                    <label>Asian: </label><label id="asianNum" style="padding-left: 20px">Y people</label><br/> <!-- needs to be replaced by DB data -->
                    <label>Hispanic: </label><label id="hispanicNum">Y people</label><br/> <!-- needs to be replaced by DB data -->
                    <label>Other: </label><label id="otherNum" style="padding-left: 20px">Y people</label><br/> <!-- needs to be replaced by DB data -->
                </div>
                <div id="errorSection" style="display:none">
                    <h3>Error Type:</h3>
                    <div id="currentError"></div>
                    <br>
                    <label for="commentArea">Comments:</label><br>
                    <textarea placeholder="Type your comment for the resolved error" id="commentArea" name="commentArea" rows="2" cols="20"></textarea>
                </div>
                <p>Options:</p>
                <div id="optionSection">
                    <button onclick="openChangeDataSection()" style="width:auto;margin-right: 25px">Change Data</button>
                    <button onclick="document.getElementById('bordersPopup').style.display='block'" style="width:auto;">Fix Borders</button>
                    <br>
                </div>
                <br>
                <br>
                <button onclick="document.getElementById('errorPopup').style.display='block'" style="width:50px;height: 40px;"><img src="ee.png" alt="Error Log" style="width: 30px;height: 30px;"></button>
                <button onclick="document.getElementById('settingsPopup').style.display='block'" style="width:50px; height:40px"><img src="cog.png" alt="Settings" style="width: 30px; height:30px;"></button>
                <div>Sources:</div>
                <div>US Census Bureau</div>
                <div>Rhode Island Geographic Information System</div>
            </div>
        </div>
        <!-- right side of the page -->
        <div class="right">
            <div id="forMap">
            </div>
        </div>
        <!-- this is popup window for changing data info -->
        <div id="changeDataSection" class="modal">
            <div class="modal-content">
                <button onclick="document.getElementById('changeDataSection').style.display='none'" style="float:right;">X</button>
                <p style="text-align: center"><b>Changes</b></p>
                <label for="precinctName" style="margin-left: 180px">Name:</label>
                <input type="text" id="precinctName" name="precinctName"><br>
                <table>
                    <tr>
                        <td style="padding-right: 30px;">
                            <p><b>2016 Presidential Election:</b></p>
                            <label for="pred16Dem" style="padding-right: 10px">Democrats:</label>
                            <input type="number" id="pred16Dem" name="pred16Dem" value="0"><br><br>
                            <label for="pred16Rep">Republicans:</label>
                            <input type="number" id="pred16Rep" name="pred16Rep" value="0"><br><br>
                            <label for="pred16Other" style="padding-right: 43px">Other:</label>
                            <input type="number" id="pred16Other" name="pred16Other" value="0"><br><br>
                            <p><b>2016 Congressional Election:</b></p>
                            <label for="cong16Dem" style="padding-right: 10px">Democrats:</label>
                            <input type="number" id="cong16Dem" name="cong16Dem" value="0"><br><br>
                            <label for="cong16Rep">Republicans:</label>
                            <input type="number" id="cong16Rep" name="cong16Rep" value="0"><br><br>
                            <label for="cong16Other" style="padding-right: 43px">Other:</label>
                            <input type="number" id="cong16Other" name="cong16Other" value="0"><br><br>
                            <p><b>2018 Congressional Election:</b></p>
                            <label for="cong18Dem" style="padding-right: 10px">Democrats:</label>
                            <input type="number" id="cong18Dem" name="cong18Dem" value="0"><br><br>
                            <label for="cong18Rep">Republicans:</label>
                            <input type="number" id="cong18Rep" name="cong18Rep" value="0"><br><br>
                            <label for="cong18Oth" style="padding-right: 43px">Other:</label>
                            <input type="number" id="cong18Oth" name="cong18Oth" value="0"><br><br>
                        </td>
                        <td>
                            <p><b>Demographic Data:</b></p>
                            <label for="whiteVotePop" style="padding-right: 20px">White:</label>
                            <input type="number" id="whiteVotePop" name="whiteVotePop" value="0"><br><br>
                            <label for="blackVotePop" style="padding-right: 20px">Black:</label>
                            <input type="number" id="blackVotePop" name="blackVotePop" value="0"><br><br>
                            <label for="asianVotePop" style="padding-right: 20px">Asian:</label>
                            <input type="number" id="asianVotePop" name="asianVotePop" value="0"><br><br>
                            <label for="hispanicVotePop">Hispanic:</label>
                            <input type="number" id="hispanicVotePop" name="hispanicVotePop" value="0"><br><br>
                            <label for="otherVotePop" style="padding-right: 20px">Other:</label>
                            <input type="number" id="otherVotePop" name="otherVotePop" value="0"><br><br>
                        </td>
                    </tr>
                </table>
                
                <center><button onclick="changePrecinctData()">Save</button></center>
            </div>
        </div>
        <!-- this is popup window for changing border -->
        <div id="bordersPopup" class="modal">
            <div class="modal-content">
                <button onclick="document.getElementById('bordersPopup').style.display='none'" style="float:right;">X</button>
                <label for="precinct1">Precinct to extend:</label>
                <select id="precinct1">
                    <option value="num1">precinct</option>
                    <option>precinct1</option>
                </select>
                <br>
                <br>
                <label for="precinct2">Precinct to connect to:</label>
                <select id="precinct2">
                    <option value="num2">precinct</option>
                    <option>precinct1</option>
                </select>
                <br><br>
                <center><button>Save</button></center>
            </div>
        </div>
        <!-- shows log of what user has done -->
        <div id="errorPopup" class="modal">
            <div class="modal-content">
                <button onclick="document.getElementById('errorPopup').style.display='none'" style="float:right;">X</button>
                <h4>Error Log</h4>
                <br><br>
                <div id="errorLog"></div>
            </div>
        </div>

        <div id="settingsPopup" class="modal">
            <div class="modal-content">
                <button onclick="document.getElementById('settingsPopup').style.display='none'" style="float:right;">X</button>
                <h4>Settings</h4>
                <br>
                <div>Map View Filter</div>
                <form id="mapFilter">
                    <input type ="checkbox" id="congressionalFilter" value="congressional">
                    <label for="congressional">Congressional Data</label><br/>
                    <input type ="checkbox" id="nationalParkFilter" value="national">
                    <label for="congrenationalssional">National Park Data</label><br/>
                    <input type ="checkbox" onchange="loadFeature()" id="precinctFilter" value="precinct" checked>
                    <label for="precinct">Precincts</label>
                </form>
                <br/><br/>
                <table>
                    <tr> <td colspan="2">Election Data Color Change </td></tr>
                    <tr>
                        <td><label>Democrat: </label></td>
                        <td><input type="color" id="demColor" onchange="changeAllColor();" name="demColor" value="#0066ff"></td>
                    </tr>
                    <tr>
                        <td><label>Republican: </label></td>
                        <td><input type="color" id="repColor" onchange="changeAllColor()" name="repCcolor" value="#ff0000"></td>
                    </tr>
                    <tr>
                        <td><label>Other: </label></td>
                        <td><input type="color" id="otherColor" onchange="changeAllColor()" name="otherColor" value="#33cc33"></td>
                    </tr>
                    
                    <tr><td colspan="2"><br/>Demographic Data Color Change </td></tr>
                    <tr>
                        <td><label>White: </label></td>
                        <td><input type="color" id="whiteColor" onchange="changeAllColor()" name="whiteColor" value="#d2b58c"></td>
                    </tr>
                    <tr> 
                        <td><label>Black: </label></td>
                        <td><input type="color" id="blackColor" onchange="changeAllColor()" name="blackColor" value="#624a2e"></td>
                    </tr>
                    <tr> 
                        <td><label>Asian: </label></td>
                        <td><input type="color" id="asianColor" onchange="changeAllColor()" name="asianColor" value="#ffbf00"></td>
                    </tr>
                    <tr> 
                        <td><label>Hispanic: </label></td>
                        <td><input type="color" id="hisColor" onchange="changeAllColor()" name="hisColor" value="#6a0dad"></td>
                    </tr>
                    <tr> 
                        <td><label>Other: </label></td>
                        <td><input type="color" id="restColor" onchange="changeAllColor()" name="restColor" value="#8affff"></td>
                    </tr>
                </table>
            </div>
        </div>
    </body>
    <script>
        function openChangeDataSection(){
            let selectedPrecinct=document.getElementById("Precincts").value;
            document.getElementById('precinctName').value = selectedPrecinct;
            if(selectedPrecinct!="precinct"){
                document.getElementById('changeDataSection').style.display='block';
            }
            populatePrecinctData();
        }
        function populatePrecinctData(){
            let selectedValue=document.getElementById("Precincts").value;
            if(selectedValue=="precinct") return;
            let selectedLayer=precincts[selectedValue];
            let selectedFeature=selectedLayer.feature;
            document.getElementById("pred16Dem").value=selectedFeature.properties.demvotpres;
            document.getElementById("pred16Rep").value=selectedFeature.properties.repvotpres;
            document.getElementById("cong16Dem").value=selectedFeature.properties.demvot16;
            document.getElementById("cong16Rep").value=selectedFeature.properties.repvot16;
            document.getElementById("cong18Dem").value=selectedFeature.properties.demvot18;
            document.getElementById("cong18Rep").value=selectedFeature.properties.repvot18;
            document.getElementById("whiteVotePop").value=Math.floor(selectedFeature.properties.whiteov18);
            document.getElementById("blackVotePop").value=Math.floor(selectedFeature.properties.blackov18);
            document.getElementById("asianVotePop").value=Math.floor(selectedFeature.properties.asianov18);
            document.getElementById("hispanicVotePop").value=Math.floor(selectedFeature.properties.hisov18);
            document.getElementById("otherVotePop").value=Math.floor(selectedFeature.properties.otherov18);
        }
        function switchDataSection(){
            if(document.getElementById("dataSection").value == "election"){
                document.getElementById("electionDropdownArea").style.display="";
                document.getElementById('electionSection').style.display = "block";
                document.getElementById('demographicSection').style.display = "none";
            }
            if(document.getElementById("dataSection").value == "demographic"){
                document.getElementById("electionDropdownArea").style.display="none";
                document.getElementById('electionSection').style.display = "none";
                document.getElementById('demographicSection').style.display = "block";
            }
        }
        function zoomOut(){
            let usaCoords=[39.436192999314095,-98.26171875];
            let usaZoomLevel=4;
            mymap.setView(new L.LatLng(usaCoords[0],usaCoords[1]), usaZoomLevel);
        }
        function initLoad(){
            //L is an object that represents the library and its functions that are available.
            let usaCoords=[39.436192999314095,-98.26171875];
            let usaZoomLevel=4;
            mymap = L.map('forMap').setView(usaCoords, usaZoomLevel);
            L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors,\n\
                        <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            id: 'mapbox/streets-v11',
            accessToken: 'pk.eyJ1IjoiZTE1MzEwODgiLCJhIjoiY2s3NzdjOWl3MDRzdTNmcWtqdDNlamxhNiJ9.aN5tSOOA7nNJA0KCnOITBA'}).addTo(mymap);
            precinctLayer=L.geoJSON(null,{onEachFeature: onEachFeature}).addTo(mymap);
            stateLayer=L.geoJSON(null,{style:setShapeColor(this,"STATE_STYLE")}).addTo(mymap);
            loadFeature();
        }
        function loadFeature(){
            let statesMenu = document.getElementById("States");
            let stateName=statesMenu.value;
            //0 is rhodeisland,1 is north carolina, 2 is arizona
            let stateCoords=[[41.5801,-71.4774]];
            let zoomLevel=[10];
            unloadAll();
            let precinctFilter=document.getElementById("precinctFilter").checked;
            switch(stateName){
                case "Rhode Island":
                    let stateFP=states[stateName].properties.statefp;
                    mymap.setView(new L.LatLng(stateCoords[0][0],stateCoords[0][1]), zoomLevel);
                    if(precinctFilter) loadAllForState(stateFP);
                    break;
                default:
                    stateLayer.clearLayers();
                    statesMenu.innerHTML="<option value='State'>State</option>";
                    loadStatesForMap(stateName);
                    zoomOut();
                    break;
            }
        }
        function unloadAll(){
            precinctLayer.clearLayers();
            precincts={};
            errors={};
            clearBothSections();
            document.getElementById("errorLog").innerHTML="";
        }
        function loadAllForState(stateFP){
            loadErrorsForState(stateFP);
            loadPrecinctsForState(stateFP);
        }
        function loadErrorsForState(stateFP){
            let errorsRequest=new XMLHttpRequest();
            errorsRequest.open('GET','http://localhost:8080/errors/'+stateFP);
            errorsRequest.onload=()=> {
                let errorData=JSON.parse(errorsRequest.response);
                loadErrorDictionary(errorData);
            }
            errorsRequest.send();
        }
        function loadErrorDictionary(errorData){
            errors={};
            for(i=0;i<errorData.length;i++){
                errors[errorData[i].precinctID]=errorData[i].errorType;
            }
        }
        function loadStatesForMap(stateName){
            states={};
            let statesRequest=new XMLHttpRequest();
            statesRequest.open('GET','http://localhost:8080/states');
            statesRequest.onload=()=>{
                let statesData=JSON.parse(statesRequest.response);
                for(i=0;i<statesData.length;i++){
                    let state=prepareStateToUse(statesData[i]);
                    stateLayer.addData(state);
                    states[state.properties.name]=state;
                }
                loadStateNames();
            };
            statesRequest.send();
        }
        function loadStateNames(){
            let statesMenu = document.getElementById("States");
            let eachLayer=(singleLayer)=>{
                let feature=singleLayer.feature;
                let addedState = document.createElement("option");
                addedState.text = feature.properties.name;
                addedState.value = feature.properties.name;
                statesMenu.options.add(addedState);
            }
            stateLayer.eachLayer(eachLayer);
        }
        function loadPrecinctsForState(stateFP){
            let precinctsRequest=new XMLHttpRequest();
            precinctsRequest.open('GET','http://localhost:8080/precincts/'+stateFP);
            precinctsRequest.onload=()=> {
                let precinctsData=JSON.parse(precinctsRequest.response);
                for(i=0;i<precinctsData.length;i++){
                    precinctLayer.addData(preparePrecinctToUse(precinctsData[i]));
                }
                loadPrecinctDictionary();
            }
            precinctsRequest.send();
        }
        function loadDemographicForPrecinct(precinctID){
            let demographicRequest=new XMLHttpRequest();
            demographicRequest.open('GET','http://localhost:8080/precincts/demographic/'+precinctID);
            demographicRequest.onload=()=>{
                
            }
        }
        function prepareStateToUse(state){
            let stateShape=JSON.parse(state["state_geojson"]);
            let newState={};
            newState["type"]="Feature";
            newState["properties"]={};
            newState.properties["statefp"]=state["statefp"];
            newState.properties["name"]=state["name"];
            newState.properties["ogrFID"]=state["ogrFID"];
            newState["geometry"]={};
            newState.geometry["type"]=stateShape["type"];
            newState.geometry["coordinates"]=stateShape["coordinates"];
            return newState;
        }
        function preparePrecinctToUse(precinct){
            let precinctShape=JSON.parse(precinct["shape_geojson"]);
            let newPrecinct={};
            let errorType=errors[precinct["ogrFID"]];
            newPrecinct["type"]="Feature";
            newPrecinct["properties"]={};
            /*newPrecinct.properties["ogrFID"]=precinct["ogrFID"];
            newPrecinct.properties["name"]=precinct["name"]
            newPrecinct.properties["statefp"]=precinct["statefp"]
            newPrecinct["geometry"]={};
            newPrecinct.geometry["type"]=precinctShape["type"];
            newPrecinct.geometry["coordinates"]=precinctShape["coordinates"];
            **/
            newPrecinct.properties["aminov18"]=precinct["aminov18"];
            newPrecinct.properties["asianov18"]=precinct["asianov18"];
            newPrecinct.properties["blackov18"]=precinct["blackov18"];
            newPrecinct.properties["demvot16"]=precinct["demvot16"];
            newPrecinct.properties["demvot18"]=precinct["demvot18"];
            newPrecinct.properties["demvotpres"]=precinct["demvotpres"];
            newPrecinct.properties["hawov18"]=precinct["hawov18"];
            newPrecinct.properties["hisov18"]=precinct["hisov18"];
            newPrecinct.properties["name"]=precinct["name"];
            newPrecinct.properties["otherov18"]=precinct["otherov18"];
            newPrecinct.properties["othvot16"]=precinct["othvot16"];
            newPrecinct.properties["othvot18"]=precinct["othvot18"];
            newPrecinct.properties["othvotpres"]=precinct["othvotpres"];
            newPrecinct.properties["pop100"]=precinct["pop100"];
            newPrecinct.properties["repvot16"]=precinct["repvot16"];
            newPrecinct.properties["repvot18"]=precinct["repvot18"];
            newPrecinct.properties["repvotpres"]=precinct["repvotpres"];
            newPrecinct.properties["whiteov18"]=precinct["whiteov18"];
            newPrecinct.properties["ogrFID"]=precinct["ogrFID"];
            newPrecinct.properties["totvotpres"]=precinct["totvotpres"];
            newPrecinct.properties["totvot16"]=precinct["totvot16"];
            newPrecinct.properties["totvot18"]=precinct["totvot18"];
            newPrecinct.properties["statefp"]=precinct["statefp"];
            if(errorType==undefined) newPrecinct.properties["errorType"]="NONE";
            else newPrecinct.properties["errorType"]=errorType;
            newPrecinct["geometry"]={};
            newPrecinct.geometry["type"]=precinctShape["type"];
            newPrecinct.geometry["coordinates"]=precinctShape["coordinates"];
            return newPrecinct;
        }
        function loadPrecinctDictionary(){
            precincts={};
            let eachLayer=(singleLayer)=>{
                let feature=singleLayer.feature;
                precincts[feature.properties.name]=singleLayer;
            }
            precinctLayer.eachLayer(eachLayer);
        }
        function setShapeColor(feature,shapeStyle){
            switch(shapeStyle){
                case "STATE_STYLE": 
                    return{
                        fillColor:'none',
                        weight:3,
                        color:'black'
                    };
                case "NEW_PREC_STYLE":
                    return{
                        fillOpacity: 0.8
                    };
                case "OLD_PREC_STYLE":
                    return{
                        fillOpacity: 0.2,
                        weight:3
                    };
                case "DEM_STYLE":
                    return{
                        color:document.getElementById("demColor").value
                    };
                case "REP_STYLE":
                    return{
                        color:document.getElementById("repColor").value
                    };
                case "OTHER_ELECTION_STYLE":
                    return{
                        color:document.getElementById("otherColor").value
                    };
                case "OTHER_DEMO_STYLE":
                    return{
                        color:document.getElementById("restColor").value
                    };
                case "WHITE_STYLE":
                    return{
                        color:document.getElementById("whiteColor").value
                    };
                case "BLACK_STYLE":
                    return{
                        color:document.getElementById("blackColor").value
                    };
                case "ASIAN_STYLE":
                    return{
                        color:document.getElementById("asianColor").value
                    };
                case "HIS_STYLE":
                    return{
                        color:document.getElementById("hisColor").value
                    };
                case "GHOST_STYLE":
                    return{
                        color:'gray'
                    };
                case "ERROR_STYLE":
                    return{
                        color:'orange'
                    }
                default:
                    console.log(feature);
                    console.log("un-intended");
            }
        }
        function setNPS(e){
            this.setStyle(setShapeColor(this,"NEW_PREC_STYLE"));
        }
        function setOPS(e){
            this.setStyle(setShapeColor(this,"OLD_PREC_STYLE"));
        }
        function precinctZoom(precinctCenter,precinctSize){
            //console.log(precinctSize);
            let precinctZoomLevel=10.5;
            if(precinctSize<99999999) precinctZoomLevel=11;
            if(precinctSize<59999999) precinctZoomLevel=11.5;
            if(precinctSize<9999999) precinctZoomLevel=12;
            if(precinctSize<5999999) precinctZoomLevel=12.5;
            if(precinctSize<999999) precinctZoomLevel=13;
            if(precinctSize<599999) precinctZoomLevel=13.5;
            //console.log(precinctZoomLevel);
            let centerCoords=precinctCenter.geometry.coordinates;
            //resets center
            mymap.setView(new L.LatLng(0,0),precinctZoomLevel);
            mymap.setView(new L.LatLng(centerCoords[1],centerCoords[0]),precinctZoomLevel);
        }
        function setDemographicSection(feat){
            let whiteVotePop=feat.properties.whiteov18;
            let blackVotePop=feat.properties.blackov18;
            let asianVotePop=feat.properties.asianov18;
            let hispanicVotePop=feat.properties.hisov18;
            let otherVotePop=feat.properties.otherov18;
            let totVotePop=feat.properties.pop100;

            document.getElementById("whiteNum").innerHTML=Math.floor(whiteVotePop);
            document.getElementById("blackNum").innerHTML=Math.floor(blackVotePop);
            document.getElementById("asianNum").innerHTML=Math.floor(asianVotePop);
            document.getElementById("hispanicNum").innerHTML=Math.floor(hispanicVotePop);
            document.getElementById("otherNum").innerHTML=Math.floor(otherVotePop);
            document.getElementById("totVotePop").innerHTML=Math.floor(totVotePop);
        }
        function setElectionSection(){
            //no selected precinct
            let selectedLayer=precincts[selectedPrecinct];
            let selectedFeature=selectedLayer.feature;
            let pred16D=selectedFeature.properties.demvotpres;
            let pred16R=selectedFeature.properties.repvotpres;
            let pred16O=selectedFeature.properties.othvotpres;
            let cong16D=selectedFeature.properties.demvot16;
            let cong16R=selectedFeature.properties.repvot16;
            let cong16O=selectedFeature.properties.othvot16;
            let cong18D=selectedFeature.properties.demvot18;
            let cong18R=selectedFeature.properties.repvot18;
            let cong18O=selectedFeature.properties.othvot18;
            let pred16T=selectedFeature.properties.totvotpres;
            let cong16T=selectedFeature.properties.totvot16;
            let cong18T=selectedFeature.properties.totvot18;
            
            let selectedElection = document.getElementById("year");
            if(selectedElection.options[selectedElection.selectedIndex].value == "pred16"){
                document.getElementById("totVotePop").innerHTML=pred16T + " people";
                if(pred16T==0)document.getElementById("demNum").innerHTML = 0 + " people [0%]";
                else document.getElementById("demNum").innerHTML = pred16D+ " people ["+Math.round(100*(pred16D/pred16T)) +"%]";
                if(pred16T==0) document.getElementById("repNum").innerHTML = 0 + " people [0%]";
                else document.getElementById("repNum").innerHTML = pred16R+ " people ["+Math.round(100*(pred16R/pred16T)) +"%]";
                if(pred16O==0) document.getElementById("othNum").innerHTML = 0 + " people [0%]";
                else document.getElementById("othNum").innerHTML = pred16O+ " people ["+Math.round(100*(pred16O/pred16T)) +"%]";
            }
            else if(selectedElection.options[selectedElection.selectedIndex].value == "cong16"){
                document.getElementById("demNum").innerHTML = cong16D;
                document.getElementById("repNum").innerHTML = cong16R;
                document.getElementById("totVotePop").innerHTML=cong16T + " people";
                document.getElementById("othNum").innerHTML = cong16O;
            }
            else{
                document.getElementById("demNum").innerHTML = cong18D;
                document.getElementById("repNum").innerHTML = cong18R;
                document.getElementById("othNum").innerHTML = cong18O;
                document.getElementById("totVotePop").innerHTML=cong18T + " people";
            }
        }
        function clearBothSections(){
            document.getElementById("whiteNum").innerHTML="N/A";
            document.getElementById("blackNum").innerHTML="N/A";
            document.getElementById("asianNum").innerHTML="N/A";
            document.getElementById("hispanicNum").innerHTML="N/A";
            document.getElementById("otherNum").innerHTML="N/A";
            document.getElementById("totVotePop").innerHTML="N/A";
            document.getElementById("demNum").innerHTML ="N/A";
            document.getElementById("repNum").innerHTML ="N/A";
            document.getElementById("othNum").innerHTML ="N/A";
        }
        function precMenuChange(selectedValue){
            //no dropdown
            let selectedLayer=precincts[selectedValue];
            let selectedFeature=selectedLayer.feature;
            
            showPrecinctOnClick(selectedLayer,selectedFeature);
        }
        function showPrecinctOnClick(selectedLayer,selectedFeature){
            precinctZoom(turf.centroid(selectedFeature),turf.area(selectedFeature));
            precinctLayer.setStyle(setShapeColor(precinctLayer,"OLD_PREC_STYLE"));
            selectedLayer.setStyle(setShapeColor(selectedLayer,"NEW_PREC_STYLE"));
            setDemographicSection(selectedFeature);
            setElectionSection(selectedFeature);
            showError(selectedLayer,selectedFeature.properties.errorType);
        }
        function changeAllColor(){
            for(i in precincts){
                let singleLayer=precincts[i];
                let feature=singleLayer.feature;
                changeFeatColor(feature,singleLayer);
            }
        }
        function changeFeatColor(selectedFeature,selectedLayer){
            if(selectedFeature.properties.errorType!="NONE" && selectedFeature.properties.errorType!="RESOLVED"){
                selectedLayer.setStyle(setShapeColor(selectedLayer,"ERROR_STYLE"));
            }
            else{
                let dataType=document.getElementById("dataSection").value;
                switch (dataType){
                    case "demographic":
                        let whiteov18=selectedFeature.properties.whiteov18;
                        let blackov18=selectedFeature.properties.blackov18;
                        let asianov18=selectedFeature.properties.asianov18;
                        let hisov18=selectedFeature.properties.hisov18;
                        let otherov18=selectedFeature.properties.otherov18;
                        let majorityRace=Math.max(whiteov18,blackov18,asianov18,hisov18,otherov18);
                        switch(majorityRace){
                            case 0: {selectedLayer.setStyle(setShapeColor(selectedLayer,"GHOST_STYLE")); break;}
                            case whiteov18: {selectedLayer.setStyle(setShapeColor(selectedLayer,"WHITE_STYLE")); break;}
                            case blackov18: {selectedLayer.setStyle(setShapeColor(selectedLayer,"BLACK_STYLE")); break;}
                            case asianov18: {selectedLayer.setStyle(setShapeColor(selectedLayer,"ASIAN_STYLE")); break;}
                            case hisov18: {selectedLayer.setStyle(setShapeColor(selectedLayer,"HIS_STYLE")); break;}
                            case otherov18: {selectedLayer.setStyle(setShapeColor(selectedLayer,"OTHER_DEMO_STYLE")); break;}
                        }
                        break;
                    case "election":
                        let majorityParty=0;
                        let electionValue=document.getElementById("year").value;
                        switch(electionValue){
                            case "pred16":
                                let demvotpres=selectedFeature.properties.demvotpres;
                                let repvotpres=selectedFeature.properties.repvotpres;
                                let othvotpres=selectedFeature.properties.othvotpres;
                                majorityParty=Math.max(demvotpres,repvotpres,othvotpres);
                                switch(majorityParty){
                                    case 0: {selectedLayer.setStyle(setShapeColor(selectedLayer,"GHOST_STYLE")); break;}
                                    case demvotpres: {selectedLayer.setStyle(setShapeColor(selectedLayer,"DEM_STYLE")); break;}
                                    case repvotpres: {selectedLayer.setStyle(setShapeColor(selectedLayer,"REP_STYLE")); break;}
                                    case othvotpres: {selectedLayer.setStyle(setShapeColor(selectedLayer,"OTHER_ELECTION_STYLE")); break;}
                                }
                                break;
                            case "cong16":
                                let demvot16=selectedFeature.properties.demvot16;
                                let repvot16=selectedFeature.properties.repvot16;
                                let othvot16=selectedFeature.properties.othvot16;
                                majorityParty=Math.max(demvot16,repvot16,othvot16);
                                switch(majorityParty){
                                    case 0: {selectedLayer.setStyle(setShapeColor(selectedLayer,"GHOST_STYLE")); break;}
                                    case demvot16: {selectedLayer.setStyle(setShapeColor(selectedLayer,"DEM_STYLE")); break;}
                                    case repvot16: {selectedLayer.setStyle(setShapeColor(selectedLayer,"REP_STYLE")); break;}
                                    case othvot16: {selectedLayer.setStyle(setShapeColor(selectedLayer,"OTHER_ELECTION_STYLE")); break;}
                                }
                                break;
                            case "cong18":
                                let demvot18=selectedFeature.properties.demvot18;
                                let repvot18=selectedFeature.properties.repvot18;
                                let othvot18=selectedFeature.properties.othvot18;
                                majorityParty=Math.max(demvot18,repvot18,othvot18);
                                switch(majorityParty){
                                    case 0: {selectedLayer.setStyle(setShapeColor(selectedLayer,"GHOST_STYLE")); break;}
                                    case demvot18: {selectedLayer.setStyle(setShapeColor(selectedLayer,"DEM_STYLE")); break;}
                                    case repvot18: {selectedLayer.setStyle(setShapeColor(selectedLayer,"REP_STYLE")); break;}
                                    case othvot18: {selectedLayer.setStyle(setShapeColor(selectedLayer,"OTHER_ELECTION_STYLE")); break;}
                                }
                                break;
                        }
                }
            }
        }
        function onClick(e){
            let selectedLayer=e.target;
            let featureInLayer=selectedLayer.feature;
            if(feature.properties.demographic==null){
                loadDemographicForPrecinct(feature.properties.ogrFID);
            }
            showPrecinctOnClick(selectedLayer,featureInLayer);
        }
        function prepareErrorToSend(feature){
            let today = new Date();
            let dateTime = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate()+" "+today.getHours() + ":" + today.getMinutes()+":"+today.getSeconds();
            let comment="["+dateTime+"] >>"+document.getElementById("commentArea").value+"<br/>";
            let preparedError={};
            preparedError["comment"]=document.getElementById("commentArea").value;
            document.getElementById("errorLog").innerHTML+="<div style=\'border-style:solid\'>Error Resolved on: "+feature.properties.name+" from ERROR: "+feature.properties.errorType+". <br/> Optional Comment: "+comment+"</div><br/>";
            preparedError["errorType"]="RESOLVED";
            feature.properties.errorType="RESOLVED";
            document.getElementById("commentArea").value="";
            return preparedError;
        }
        function updateError(id,newError){
            let errorRequest=new XMLHttpRequest();
            errorRequest.open('PUT','http://localhost:8080/errors/'+id);
            if(newError){
                errorRequest.setRequestHeader('Content-Type','application/json');
            }
            newError=JSON.stringify(newError);
            errorRequest.send(newError);
        }
        function setGhostPrecinct(layer){
            let feature=layer.feature;
            let featureID=feature.properties.ogrFID;
            let buttonToBeDeleted=document.getElementById(feature.properties.name+"_error");
            buttonToBeDeleted.parentNode.removeChild(buttonToBeDeleted);
            let errorDiv=document.getElementById("currentError");
            layer.setStyle(setShapeColor(layer,"GHOST_STYLE"));
            errorDiv.innerHTML="";
            document.getElementById("errorSection").style.display="none";
            updatePrecinct(featureID,preparePrecinctToSend(feature));
            updateError(featureID,prepareErrorToSend(feature))
        }
        function updatePrecinct(selectedID,newPrecinct){
            let precinctRequest=new XMLHttpRequest();
            precinctRequest.open('PUT','http://localhost:8080/precincts/'+selectedID);
            if(newPrecinct){
                precinctRequest.setRequestHeader('Content-Type','application/json');
            }
            let precinct=JSON.stringify(newPrecinct);
            console.log(precinct);
            precinctRequest.send(precinct);
        }
        function preparePrecinctToSend(feature){
            let preparedPrecinct={};
            /*
            preparedPrecinct["ogrFID"]=feature.properties.ogrFID;
            preparedPrecinct["name"]=feature.properties.name;
            preparedPrecinct["shape_geojson"[]=feature.geometry;
            preparedPrecinct["error"]=feature.properties.error;
            preparedPrecinct["demographic"]=feature.properties.demographic;
            preparedPrecinct["election"]=feature.properties.election;
            
            * */
            preparedPrecinct["aminov18"]=feature.properties.aminov18;
            preparedPrecinct["asianov18"]=feature.properties.asianov18;
            preparedPrecinct["blackov18"]=feature.properties.blackov18;
            preparedPrecinct["demvot16"]=feature.properties.demvot16;
            preparedPrecinct["demvot18"]=feature.properties.demvot18;
            preparedPrecinct["demvotpres"]=feature.properties.demvotpres;
            preparedPrecinct["hawov18"]=feature.properties.hawov18;
            preparedPrecinct["hisov18"]=feature.properties.hisov18;
            preparedPrecinct["name"]=feature.properties.name;
            preparedPrecinct["otherov18"]=feature.properties.otherov18;
            preparedPrecinct["othvot16"]=feature.properties.othvot16;
            preparedPrecinct["othvot18"]=feature.properties.othvot18;
            preparedPrecinct["othvotpres"]=feature.properties.othvotpres;
            preparedPrecinct["pop100"]=feature.properties.pop100;
            preparedPrecinct["statefp"]=feature.properties.statefp;
            preparedPrecinct["totvotpres"]=feature.properties.totvotpres;
            preparedPrecinct["totvot16"]=feature.properties.totvot16;
            preparedPrecinct["totvot18"]=feature.properties.totvot18;
            preparedPrecinct["repvot16"]=feature.properties.repvot16;
            preparedPrecinct["repvot18"]=feature.properties.repvot18;
            preparedPrecinct["repvotpres"]=feature.properties.repvotpres;
            preparedPrecinct["whiteov18"]=feature.properties.whiteov18;
            preparedPrecinct["shape_geojson"]=JSON.stringify(feature.geometry);
            return preparedPrecinct;
        }
        function mergePrecincts(layer){
            let feature=layer.feature;
            let buttonToBeDeleted=document.getElementById(feature.properties.name+"_error");
            buttonToBeDeleted.parentNode.removeChild(buttonToBeDeleted);
            let errorDiv=document.getElementById("currentError");
            errorDiv.innerHTML="";
            document.getElementById("errorSection").style.display="none";
            
            console.log(feature);
            let newPrecinct={"type":"Feature",
                "properties":feature.properties,
                "geometry":{
                    "type":"Polygon",
                    "coordinates":[feature.geometry.coordinates[0][0]]
                }
            };
            layer.remove();
            precinctLayer.removeLayer(layer);
            precinctLayer.addData(newPrecinct);
            
            updatePrecinct(feature.properties.ogrFID,newPrecinct);
            updateError(feature.properties.ogrFID,prepareErrorToSend(newPrecinct));
        }
        function showError(layer,errorType){
            let featureName=layer.feature.properties.name;
            let errorDiv=document.getElementById("currentError");
            switch(errorType){
                case "GHOST":
                    document.getElementById("errorSection").style.display="block";
                    errorDiv.innerHTML="Ghost Precinct? <br>\n\
                        <button onclick='setGhostPrecinct(precincts[\""+featureName+"\"])'>Yes</button>\n\
                        <button onclick='openChangeDataSection();'>No</button>";
                    break;
                case "DONUT":
                    document.getElementById("errorSection").style.display="block";
                    errorDiv.innerHTML="Merge Precinct<br>\n\
                        <button onclick='mergePrecincts(precincts[\""+featureName+"\"])'>Yes</button>";
                    break;
                default:
                    document.getElementById("errorSection").style.display="none";
                    errorDiv.innerHTML="";
            }
        }
        function changePrecinctData(){
            let pred16Dem=document.getElementById("pred16Dem").value;
            let pred16Rep=document.getElementById("pred16Rep").value;
            let cong16Dem=document.getElementById("cong16Dem").value;
            let cong16Rep=document.getElementById("cong16Rep").value;
            let cong18Dem=document.getElementById("cong18Dem").value;
            let cong18Rep=document.getElementById("cong18Rep").value;
            let whiteVotePop=document.getElementById("whiteVotePop").value;
            let blackVotePop=document.getElementById("blackVotePop").value;
            let asianVotePop=document.getElementById("asianVotePop").value;
            let hispanicVotePop=document.getElementById("hispanicVotePop").value;
            let otherVotePop=document.getElementById("otherVotePop").value;
            
            //no drop down
            let selectedLayer=precincts[selectedValue];
            let selectedFeature=selectedLayer.feature;
            let selectedID=selectedFeature.properties.ogrFID;
            changePrecinctVotingData(selectedFeature,pred16Dem,pred16Rep,cong16Dem,cong16Rep,cong18Dem,cong18Rep);
            changePrecinctDemographicData(selectedFeature,whiteVotePop,blackVotePop,asianVotePop,hispanicVotePop,otherVotePop);
            
            //changes the name of the feature, removes the name off the dropdown, and adds the new name in
            if(selectedValue!=document.getElementById("precinctName").value){
                selectedFeature.properties.name=document.getElementById("precinctName").value;
                precincts[selectedFeature.properties.name]=precincts[selectedValue];
                delete precincts[selectedValue];
                console.log(selectedFeature);
            }
            showPrecinctOnClick(selectedLayer,selectedFeature);
            
            if(selectedFeature.properties.errorType=="GHOST" && document.getElementById("pred16Dem").value!=0){
                let selectedError=document.getElementById(selectedValue+"_error");
                if(selectedError!=undefined){
                    selectedError.parentNode.removeChild(selectedError);
                    document.getElementById("currentError").innerHTML="";
                    document.getElementById("errorSection").style.display="none";
                }
                updateError(selectedFeature.properties.ogrFID,prepareErrorToSend(selectedFeature));
            }
            document.getElementById('changeDataSection').style.display='none';
            changeFeatColor(selectedLayer.feature,selectedLayer);
            updatePrecinct(selectedID,preparePrecinctToSend(selectedFeature));
        }
	function changePrecinctDemographicData(feature,whiteVotePop,blackVotePop,asianVotePop,hispanicVotePop,otherVotePop){
            feature.properties.whiteov18=parseInt(whiteVotePop);
            feature.properties.blackov18=parseInt(blackVotePop);
            feature.properties.asianov18=parseInt(asianVotePop);
            feature.properties.hisov18=parseInt(hispanicVotePop);
            feature.properties.otherov18=parseInt(otherVotePop);
	}
        function changePrecinctVotingData(feature,pred16Dem,pred16Rep,cong16Dem,cong16Rep,cong18Dem,cong18Rep){
            feature.properties.demvotpres=parseInt(pred16Dem);
            feature.properties.repvotpres=parseInt(pred16Rep);
            feature.properties.demvot16=parseInt(cong16Dem);
            feature.properties.repvot16=parseInt(cong16Rep);
            feature.properties.demvot18=parseInt(cong18Dem);
            feature.properties.repvot18=parseInt(cong18Rep);
        }
        function onEachFeature(feature,layer){
            layer.on({
                click: onClick
            });
            if(feature.properties.errorType=="GHOST"){
               document.getElementById("errorLog").innerHTML+="<div id=\""+feature.properties.name+"_error\"><button onclick='document.getElementById(\"errorPopup\").style.display=\"none\";precMenuChange(\""+feature.properties.name+"\");'>Ghost Precinct Found ["+feature.properties.name+"](Requires Verification)</button></div>";
            }
            if(feature.properties.name=="Burrillville 0302" && feature.geometry.type=="MultiPolygon"){
               document.getElementById("errorLog").innerHTML+="<div id=\""+feature.properties.name+"_error\"><button onclick='document.getElementById(\"errorPopup\").style.display=\"none\";precMenuChange(\""+feature.properties.name+"\");'>Donut Precinct Found ["+feature.properties.name
                       +"](Requires Modification)</button></div>";
            }
            changeFeatColor(feature,layer);
        }
        initLoad();
    </script>
</html>
